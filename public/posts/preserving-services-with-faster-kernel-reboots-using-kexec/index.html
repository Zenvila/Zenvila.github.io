<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=light data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=theme-color><title>Preserving Services With Faster Kernel Reboots Using Kexec &#183; Zenvila</title><meta name=title content="Preserving Services With Faster Kernel Reboots Using Kexec &#183; Zenvila"><meta name=keywords content="Security,Linux,Cloud,"><link rel=canonical href=https://zenvila.github.io/posts/preserving-services-with-faster-kernel-reboots-using-kexec/><meta name=author content="Haris Shahzad"><link href=https://github.com/zenvila rel=me><link href=https://linkedin.com/in/haris-shahzad786 rel=me><meta property="og:url" content="https://zenvila.github.io/posts/preserving-services-with-faster-kernel-reboots-using-kexec/"><meta property="og:site_name" content="Zenvila"><meta property="og:title" content="Preserving Services With Faster Kernel Reboots Using Kexec"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-28T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-28T00:00:00+00:00"><meta property="article:tag" content="Security"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Cloud"><meta name=twitter:card content="summary"><meta name=twitter:title content="Preserving Services With Faster Kernel Reboots Using Kexec"><link type=text/css rel=stylesheet href=/css/main.bundle.min.c61736128cfa071f52268b924e8b8c8dff7f9e962caae1e812053e9e023a4e1c1c95239d517406a4002933de9dd5ad84667956aa9d4230a25024e7e502058ca1.css integrity="sha512-xhc2Eoz6Bx9SJouSTouMjf9/npYsquHoEgU+ngI6ThwclSOdUXQGpAApM96d1a2EZnlWqp1CMKJQJOflAgWMoQ=="><script type=text/javascript src=/js/appearance.min.6f41174b3a05b680820fe08cadbfa5fb7a7ca347b76a0955cdc68b9d8aca1ce24f0547e138cea33bcc7904d551a90afcb1cc7f2d9fe8557075d501419046c08c.js integrity="sha512-b0EXSzoFtoCCD+CMrb+l+3p8o0e3aglVzcaLnYrKHOJPBUfhOM6jO8x5BNVRqQr8scx/LZ/oVXB11QFBkEbAjA=="></script><script src=/lib/zoom/zoom.min.umd.a527109b68c082a70f3697716dd72a9d5aa8b545cf800cecbbc7399f2ca6f6e0ce3e431f2062b48bbfa47c9ea42822714060bef309be073f49b9c0e30d318d7b.js integrity="sha512-pScQm2jAgqcPNpdxbdcqnVqotUXPgAzsu8c5nyym9uDOPkMfIGK0i7+kfJ6kKCJxQGC+8wm+Bz9JucDjDTGNew=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.712c423dd585dfd031bf75a70aad3af4b3de24c6eec1fef682d92724b4026b842cf843c8535587e5096039348125c57ff1bea2d46b2b4af8124673ca085880c4.js integrity="sha512-cSxCPdWF39Axv3WnCq069LPeJMbuwf72gtknJLQCa4Qs+EPIU1WH5QlgOTSBJcV/8b6i1GsrSvgSRnPKCFiAxA==" data-copy=Copy data-copied=Copied></script><script src=/lib/jquery/jquery.slim.min.b0dca576e87d7eaa5850ae4e61759c065786cdb6489d68fcc82240539eebd5da522bdb4fda085ffd245808c8fe2acb2516408eb774ef26b5f6015fc6737c0ea8.js integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA=="></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Preserving Services With Faster Kernel Reboots Using Kexec","headline":"Preserving Services With Faster Kernel Reboots Using Kexec","inLanguage":"en","url":"https://zenvila.github.io/posts/preserving-services-with-faster-kernel-reboots-using-kexec/","author":{"@type":"Person","name":"Haris Shahzad"},"copyrightYear":"2024","dateCreated":"2024-08-28T00:00:00\u002b00:00","datePublished":"2024-08-28T00:00:00\u002b00:00","dateModified":"2024-08-28T00:00:00\u002b00:00","keywords":["Security","Linux","Cloud"],"mainEntityOfPage":"true","wordCount":"2223"}]</script></head><body class="flex flex-col h-screen m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32 text-lg bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral bf-scrollbar"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 pe-2 dark:text-primary-400">&darr;</span>
Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 z-100"><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl bg-neutral/25 dark:bg-neutral-800/25"></div><div class="relative m-auto leading-7 max-w-7xl px-6 sm:px-14 md:px-24 lg:px-32"><div class="main-menu flex items-center w-full gap-2 p-1 pl-0"><div><a href=/ class=flex><span class=sr-only>Zenvila</span>
<span class="logo object-scale-down object-left nozoom"><svg viewBox="0 0 100 100"><ellipse cx="50" cy="65" rx="30" ry="25" fill="#000"/><ellipse cx="50" cy="65" rx="20" ry="18" fill="#fff"/><circle cx="50" cy="35" r="20" fill="#000"/><circle cx="45" cy="32" r="3" fill="#fff"/><circle cx="55" cy="32" r="3" fill="#fff"/><circle cx="45" cy="32" r="1.5" fill="#000"/><circle cx="55" cy="32" r="1.5" fill="#000"/><path d="M50 38l-5 4H55z" fill="orange"/><ellipse cx="40" cy="88" rx="8" ry="5" fill="orange"/><ellipse cx="60" cy="88" rx="8" ry="5" fill="orange"/><ellipse cx="25" cy="60" rx="12" ry="18" fill="#000"/><ellipse cx="75" cy="60" rx="12" ry="18" fill="#000"/></svg></span></a></div><div class="flex items-center ms-auto"><div class="hidden md:flex"><nav class="flex items-center gap-x-5 h-12"><a href=/about/ class="flex items-center bf-icon-color-hover" aria-label=About title="About Me"><span class="text-base font-medium break-normal">About
</span></a><a href=/posts/ class="flex items-center bf-icon-color-hover" aria-label=Posts title=Posts><span class="text-base font-medium break-normal">Posts
</span></a><a href=/projects/ class="flex items-center bf-icon-color-hover" aria-label=Projects title=Projects><span class="text-base font-medium break-normal">Projects
</span></a><a href=/resume/ class="flex items-center bf-icon-color-hover" aria-label=Resume title=Resume><span class="text-base font-medium break-normal">Resume
</span></a><a href=/tags/ class="flex items-center bf-icon-color-hover" aria-label=Tags title=Tags><span class="text-base font-medium break-normal">Tags
</span></a><button id=search-button aria-label=Search class="text-base bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base bf-icon-color-hover"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav></div><div class="flex md:hidden"><div class="flex items-center h-14 gap-4"><button id=search-button-mobile aria-label=Search class="flex items-center justify-center bf-icon-color-hover" title="Search (/)">
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile type=button aria-label="Dark mode switcher" class="flex items-center justify-center text-neutral-900 hover:text-primary-600 dark:text-neutral-200 dark:hover:text-primary-400"><div class=dark:hidden><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="hidden dark:block"><span class="relative block icon"><svg viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button>
<input type=checkbox id=mobile-menu-toggle autocomplete=off class="hidden peer">
<label for=mobile-menu-toggle class="flex items-center justify-center cursor-pointer bf-icon-color-hover"><span class="relative block icon"><svg viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></label><div role=dialog aria-modal=true style=scrollbar-gutter:stable class="fixed inset-0 z-50 invisible overflow-y-auto px-6 py-20 opacity-0 transition-[opacity,visibility] duration-300 peer-checked:visible peer-checked:opacity-100 bg-neutral-50/97 dark:bg-neutral-900/99
bf-scrollbar"><label for=mobile-menu-toggle class="fixed end-8 top-5 flex items-center justify-center z-50 h-12 w-12 cursor-pointer select-none rounded-full bf-icon-color-hover border bf-border-color bf-border-color-hover bg-neutral-50 dark:bg-neutral-900"><span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></label><nav class="mx-auto max-w-md space-y-6"><div class=px-2><a href=/about/ aria-label=About class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title="About Me" class="text-2xl font-bold tracking-tight">About</span></a></div><div class=px-2><a href=/posts/ aria-label=Posts class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Posts class="text-2xl font-bold tracking-tight">Posts</span></a></div><div class=px-2><a href=/projects/ aria-label=Projects class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Projects class="text-2xl font-bold tracking-tight">Projects</span></a></div><div class=px-2><a href=/resume/ aria-label=Resume class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Resume class="text-2xl font-bold tracking-tight">Resume</span></a></div><div class=px-2><a href=/tags/ aria-label=Tags class="flex items-center gap-4 group bf-icon-color-hover text-neutral-700 dark:text-neutral-200"><span title=Tags class="text-2xl font-bold tracking-tight">Tags</span></a></div></nav></div></div></div></div></div></div></div><script type=text/javascript src=/js/background-blur.min.00a57c73ea12f2cab2980c3c3d649e89f6d82f190f74bbe2b67f2f5e39ab7d032ece47086400ca05396758aace13299da49aca43ea643d2625e62c506267a169.js integrity="sha512-AKV8c+oS8sqymAw8PWSeifbYLxkPdLvitn8vXjmrfQMuzkcIZADKBTlnWKrOEymdpJrKQ+pkPSYl5ixQYmehaQ==" data-blur-id=menu-blur></script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"><img id=background-image src=https://zenvila.github.io/images/posts/preserving-services-with-faster-kernel-reboots-using-kexec.jpeg role=presentation loading=eager decoding=async fetchpriority=high class="absolute inset-0 w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><header id=single_header class="mt-5 max-w-prose"><div class="mt-1 mb-3 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime=2024-08-28T00:00:00+00:00>28 August 2024</time><span class="px-2 text-primary-500">&#183;</span><span>2223 words</span><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">11 mins</span></div><div class="flex flex-row flex-wrap items-center"><a class="relative mt-[0.5rem] me-2" href=/tags/security/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Security
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/linux/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Linux
</span></span></a><a class="relative mt-[0.5rem] me-2" href=/tags/cloud/><span class="flex cursor-pointer"><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Cloud</span></span></a></div></div><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Preserving Services With Faster Kernel Reboots Using Kexec</h1></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><h1 class="relative group">Preserving Services with Faster Kernel Reboots Using Kexec<div id=preserving-services-with-faster-kernel-reboots-using-kexec class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#preserving-services-with-faster-kernel-reboots-using-kexec aria-label=Anchor>#</a></span></h1><h1 class="relative group"><strong>Improving the Kexec Boot Time</strong><div id=improving-the-kexec-boot-time class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#improving-the-kexec-boot-time aria-label=Anchor>#</a></span></h1><p>We will see why the kernel boot is important. Basically, we will explore live updates of the host kernel and also go through some of the different optimizations that have been done to improve boot time, especially specialized for the specific <strong>ECI device</strong>.</p><h2 class="relative group"><strong>ECI:</strong><div id=eci class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#eci aria-label=Anchor>#</a></span></h2><p>This is a software platform that leverages technologies like <strong>virtualization</strong> and <strong>containerization</strong> to manage control execution as <strong>containerized microservices</strong> in industrial environments.
We will also conclude with whether there is anything more to improve and what are large areas that can further enhance <strong>boot time</strong>.</p><h2 class="relative group"><strong>Let‚Äôs First Start With the Motivation ‚Äì Why?</strong><div id=lets-first-start-with-the-motivation--why class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#lets-first-start-with-the-motivation--why aria-label=Anchor>#</a></span></h2><p>In both public and private clouds, once the workload is started and the virtual machines are running, people do not want the host environment to change ‚Äî they try to keep it the same as long as possible.</p><p>But updating the host kernel is a <strong>severe distraction</strong>, especially due to the <strong>very large downtime</strong> it can cause for the virtual machines.</p><p>However, updating the host kernel obviously brings <strong>security</strong>, <strong>functionality</strong>, and <strong>performance</strong> benefits ‚Äî which not all of the alternative methods like <strong>kernel patching</strong> deliver, as kernel patching is mostly meant for <strong>critical security fixes</strong> and <strong>bug fixes</strong>.</p><h3 class="relative group"><strong>What is Kernel Patching?</strong><div id=what-is-kernel-patching class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#what-is-kernel-patching aria-label=Anchor>#</a></span></h3><p>Kernel patching is used to address <strong>bug fixes</strong>, <strong>security vulnerabilities</strong>, or to introduce <strong>new features</strong> or functionalities. Kernel patching can be performed in two ways:</p><ul><li><p>By updating the entire kernel (requires a <strong>system reboot</strong>)</p></li><li><p>Through <strong>live patching</strong>, which allows updates to be applied <strong>without interrupting</strong> the system</p></li></ul><h2 class="relative group"><strong>Two Ways to Update the Host Kernel:</strong><div id=two-ways-to-update-the-host-kernel class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#two-ways-to-update-the-host-kernel aria-label=Anchor>#</a></span></h2><ol><li><p><strong>Live Migration</strong></p></li><li><p><strong>Live Update</strong></p></li></ol><h3 class="relative group"><strong>Live Migration:</strong><div id=live-migration class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#live-migration aria-label=Anchor>#</a></span></h3><p>Live migration is the process of moving a <strong>running virtual machine</strong> from one physical host to another without causing too much disruption. It has major advantages, especially in handling <strong>physical hardware issues</strong>.</p><p>So, this is not the problem here ‚Äî what we have done is <strong>update the host kernel via live update</strong>. We don‚Äôt try to update the kernel in systems that already have hardware issues.</p><h2 class="relative group"><strong>Live Updates:</strong><div id=live-updates class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#live-updates aria-label=Anchor>#</a></span></h2><p>Live updates of the host kernel work by <strong>pausing</strong> and <strong>snapshotting</strong> the virtual machines running on the host, then <strong>kexec booting</strong> into the new kernel and <strong>restoring/resuming</strong> energy to the virtual machines.</p><h3 class="relative group"><strong>Advantages:</strong><div id=advantages class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#advantages aria-label=Anchor>#</a></span></h3><ul><li><p>No need for <strong>extra resources</strong> (unlike live migration)</p></li><li><p>No extra machines required</p></li><li><p>Less <strong>bandwidth</strong> consumption</p></li></ul><h3 class="relative group"><strong>Other Issues:</strong><div id=other-issues class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#other-issues aria-label=Anchor>#</a></span></h3><p>If <strong>PCI devices</strong> (Peripheral Component Interconnect) are passed through a virtual machine using <strong>VFIO pass-through</strong>, we need to <strong>preserve its IOM state</strong> (operational state of a network interface).</p><h3 class="relative group"><strong>Solution Using KVM Form and Kernel Persistent Memory</strong><div id=solution-using-kvm-form-and-kernel-persistent-memory class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#solution-using-kvm-form-and-kernel-persistent-memory aria-label=Anchor>#</a></span></h3><h3 class="relative group"><strong>What is Kernel Persistent Memory?</strong><div id=what-is-kernel-persistent-memory class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#what-is-kernel-persistent-memory aria-label=Anchor>#</a></span></h3><p>Persistent memory is a type of computer memory that <strong>retains data even after power is turned off</strong>. It combines the <strong>high speed</strong> of DRAM with the <strong>durability</strong> of SSDs. It acts as both <strong>fast memory</strong> and <strong>persistent storage</strong>, improving <strong>performance</strong> and <strong>data reliability</strong>.</p><h3 class="relative group"><strong>Another Issue:</strong><div id=another-issue class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#another-issue aria-label=Anchor>#</a></span></h3><p>Issues may also occur with <strong>host user space applications</strong> like <strong>DPDK</strong> and <strong>SPDK</strong>.</p><ul><li><p><strong>DPDK</strong> is used for networking tasks.</p></li><li><p><strong>SPDK</strong> is used for storage-related operations.</p></li></ul><h3 class="relative group"><strong>Downtime During Live Updates Includes:</strong><div id=downtime-during-live-updates-includes class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#downtime-during-live-updates-includes aria-label=Anchor>#</a></span></h3><ul><li><p>VM pause</p></li><li><p>VM snapshot</p></li><li><p>Kexec boot</p></li><li><p>VM restore</p></li><li><p>VM resume</p></li></ul><h2 class="relative group"><strong>Measuring Kernel Boot Time:</strong><div id=measuring-kernel-boot-time class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#measuring-kernel-boot-time aria-label=Anchor>#</a></span></h2><p>We can measure kernel boot time using <strong>timestamp logs</strong>.</p><p>It is measured from the log that shows the <strong>kernel version</strong> to the log that indicates the kernel is running the <strong>init process</strong>.</p><h3 class="relative group"><strong>Major Time Consumption:</strong><div id=major-time-consumption class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#major-time-consumption aria-label=Anchor>#</a></span></h3><p>Most of the time is taken by <strong>star pages</strong>.</p><h3 class="relative group"><strong>Optimization ‚Äì Enable Deferred Star Pages:</strong><div id=optimization--enable-deferred-star-pages class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#optimization--enable-deferred-star-pages aria-label=Anchor>#</a></span></h3><p>Solution: Enable <strong>deferred star pages</strong> in the init config. This defers the initialization of struct pages from a single parallel thread when the kernel <strong>swap daemon</strong> starts.</p><h2 class="relative group"><strong>Biggest Time Left: SMP Boot Time</strong><div id=biggest-time-left-smp-boot-time class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#biggest-time-left-smp-boot-time aria-label=Anchor>#</a></span></h2><h3 class="relative group"><strong>What is SMP Boot Time?</strong><div id=what-is-smp-boot-time class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#what-is-smp-boot-time aria-label=Anchor>#</a></span></h3><p>SMP boot time refers to the time required for <strong>initializing multiple processor cores</strong> and loading the operating system in a system that uses <strong>Symmetric Multiprocessing (SMP)</strong>.</p><h3 class="relative group"><strong>How SMP Boot Works on Linux Kernel:</strong><div id=how-smp-boot-works-on-linux-kernel class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#how-smp-boot-works-on-linux-kernel aria-label=Anchor>#</a></span></h3><p>CPUs are booted <strong>serially</strong>, one after another.</p><h3 class="relative group"><strong>What is BP Kick?</strong><div id=what-is-bp-kick class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#what-is-bp-kick aria-label=Anchor>#</a></span></h3><p>In the Linux kernel context, <strong>BP kick</strong> refers to using <strong>breakpoints (BP)</strong> within a kernel program to trigger debugging or runtime analysis.</p><h2 class="relative group"><strong>Parallel SMP Boot Time:</strong><div id=parallel-smp-boot-time class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#parallel-smp-boot-time aria-label=Anchor>#</a></span></h2><p>This uses <strong>multiple processors</strong> to perform tasks like:</p><ul><li><p>Loading the kernel</p></li><li><p>Initializing devices</p></li><li><p>Starting system services</p></li></ul><h3 class="relative group"><strong>Benefits:</strong><div id=benefits class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#benefits aria-label=Anchor>#</a></span></h3><ul><li><p>Faster boot times</p></li><li><p>Minimal VM downtime</p></li><li><p>Quicker recovery</p></li></ul><h3 class="relative group"><strong>Implementation:</strong><div id=implementation class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#implementation aria-label=Anchor>#</a></span></h3><p>Use the kernel parameter:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cpuhp.parallel<span class=o>=</span><span class=m>1</span></span></span></code></pre></div></div><p>This enables <strong>parallel CPU bring-up</strong>.</p><p>By using this, we can achieve:</p><ul><li><p><strong>Kernel time:</strong> 2.7s ‚Üí 1s</p></li><li><p><strong>SMP boot time:</strong> 1.7s ‚Üí 60ms</p></li></ul><h2 class="relative group"><strong>Difference Between Kernel Time and SMP Boot Time:</strong><div id=difference-between-kernel-time-and-smp-boot-time class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#difference-between-kernel-time-and-smp-boot-time aria-label=Anchor>#</a></span></h2><p>The <strong>kernel boot time</strong> is from the start of the kernel loading to the <strong>init process</strong> start.</p><p>The <strong>overall system boot time</strong> (possibly referred to as <strong>SMO</strong>) includes everything after the kernel loads ‚Äî like services and applications starting.</p><h2 class="relative group"><strong>Steps to Use Kexec for Fast Kernel Reboot:</strong><div id=steps-to-use-kexec-for-fast-kernel-reboot class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#steps-to-use-kexec-for-fast-kernel-reboot aria-label=Anchor>#</a></span></h2><h3 class="relative group">‚úÖ <strong>Why Check Boot Time?</strong><div id=-why-check-boot-time class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-why-check-boot-time aria-label=Anchor>#</a></span></h3><ul><li><p>üîç <strong>To Measure System Speed</strong>: It helps you see <strong>how long your system takes to fully start</strong>‚Äîfrom power-on to being ready to use.</p></li><li><p>üìâ <strong>Track Improvements</strong>: If you&rsquo;re optimizing your system (like using <strong>kexec</strong> or disabling unused services), this shows <strong>how much faster it gets</strong> after changes.</p></li><li><p>üõ†Ô∏è <strong>Find Slow Parts</strong>: You can <strong>identify which part is slow</strong>‚Äîfirmware, bootloader, kernel, or services‚Äîand fix the bottlenecks.</p></li><li><p>üìä <strong>Performance Comparison</strong>: Useful when comparing <strong>before-and-after times</strong> to confirm that your tweaks or updates really helped.</p></li><li><p>üß† <strong>Better Understanding</strong>: It helps you <strong>understand your system&rsquo;s startup process</strong>, which is useful for performance tuning or troubleshooting.</p></li></ul><p><strong>Command to Check Boot Time:</strong></p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>systemd-analyze</span></span></code></pre></div></div><p>üñ•Ô∏è <code>systemd-analyze</code> Output Breakdown:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Startup finished in 6.563s <span class=o>(</span>firmware<span class=o>)</span> + 4.255s <span class=o>(</span>loader<span class=o>)</span> + 4.186s <span class=o>(</span>kernel<span class=o>)</span> + 26.804s <span class=o>(</span>userspace<span class=o>)</span> <span class=o>=</span> 41.810s
</span></span><span class=line><span class=cl>graphical.target reached after 26.804s in userspace.</span></span></code></pre></div></div><p>| <strong>Component</strong> | <strong>Time Taken</strong> | <strong>Explanation</strong> |
|
|
|
|
| <code>firmware</code> | 6.563s | Time your system&rsquo;s <strong>BIOS/UEFI firmware</strong> took to initialize hardware before handing off to bootloader. |
| <code>loader</code> | 4.255s | Time taken by the <strong>bootloader</strong> (like GRUB) to load the kernel into memory. |
| <code>kernel</code> | 4.186s | Time the <strong>Linux kernel</strong> took to initialize system hardware and prepare userspace. |
| <code>userspace</code> | 26.804s | Time systemd took to start services, user processes, and the graphical environment. |
| <a href=http://graphical.target target=_blank><code>graphical.target</code></a> | ~26.8s | Indicates when your <strong>graphical desktop environment</strong> (like GNOME, KDE, etc.) was fully loaded. |</p><h3 class="relative group">üïí <strong>Total Boot Time</strong><div id=-total-boot-time class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-total-boot-time aria-label=Anchor>#</a></span></h3><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>41.810s</span></span></code></pre></div></div><h3 class="relative group">‚úÖ <strong>1. Check Current Kernel Version</strong><div id=-1-check-current-kernel-version class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-1-check-current-kernel-version aria-label=Anchor>#</a></span></h3><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>uname -r</span></span></code></pre></div></div><p>![](<a href=https://cdn.hashnode.com/res/hashnode/image/upload/v1745229707117/c76d4ac1-8700-4f13-8e41-7ac1b9fa0ca1.png target=_blank>https://cdn.hashnode.com/res/hashnode/image/upload/v1745229707117/c76d4ac1-8700-4f13-8e41-7ac1b9fa0ca1.png</a> align=&ldquo;center&rdquo;)</p><p>‚úÖ <strong>2. Install a Second Kernel (e.g., LTS)</strong></p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo pacman -Syu linux-lts linux-lts-headers</span></span></code></pre></div></div><p>‚úÖ <strong>3. Verify Installed Kernels</strong></p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls /boot</span></span></code></pre></div></div><p>‚úÖ <strong>4. Install kexec-tools</strong></p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo pacman -S kexec-tools</span></span></code></pre></div></div><p>üß† Installs the tools needed to invoke the <code>kexec()</code> syscall.</p><h3 class="relative group">‚úÖ <strong>5. Load the New Kernel into Memory (But Don&rsquo;t Boot Yet)</strong><div id=-5-load-the-new-kernel-into-memory-but-don class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-5-load-the-new-kernel-into-memory-but-don aria-label=Anchor>#</a></span></h3><p>For LTS:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo kexec -l /boot/vmlinuz-linux-lts <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initrd<span class=o>=</span>/boot/initramfs-linux-lts.img <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--command-line<span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>cat /proc/cmdline<span class=k>)</span><span class=s2>&#34;</span></span></span></code></pre></div></div><p>For default kernel:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo kexec -l /boot/vmlinuz-linux <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--initrd<span class=o>=</span>/boot/initramfs-linux.img <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--command-line<span class=o>=</span><span class=s2>&#34;</span><span class=k>$(</span>cat /proc/cmdline<span class=k>)</span><span class=s2>&#34;</span></span></span></code></pre></div></div><p>‚úÖ <strong>6. Sync and Prepare File System</strong></p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo sync
</span></span><span class=line><span class=cl>sudo systemctl isolate rescue.target</span></span></code></pre></div></div><p>üß† Enters a minimal environment to stop unnecessary services.</p><p>‚úÖ <strong>7. Save Running Processes:</strong></p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano save-running.sh</span></span></code></pre></div></div><p>paste:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>mkdir -p /var/tmp/kexec-session
</span></span><span class=line><span class=cl>ps -eo comm <span class=p>|</span> sort <span class=p>|</span> uniq &gt; /var/tmp/kexec-session/running_apps.txt</span></span></code></pre></div></div><p>Make executable:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chmod +x save-running.sh</span></span></code></pre></div></div><p>Run it:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./save-running.sh</span></span></code></pre></div></div><p>‚úÖ <strong>8. Boot into the New Kernel Without Rebooting BIOS</strong></p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo kexec -e</span></span></code></pre></div></div><p><strong>After kernal update :</strong></p><p>![](<a href=https://cdn.hashnode.com/res/hashnode/image/upload/v1745229760933/ed6a15e4-053e-46af-b8fe-2230ace73beb.png target=_blank>https://cdn.hashnode.com/res/hashnode/image/upload/v1745229760933/ed6a15e4-053e-46af-b8fe-2230ace73beb.png</a> align=&ldquo;center&rdquo;)</p><h3 class="relative group">‚úÖ <strong>9. Restore the Running Processes:</strong><div id=-9-restore-the-running-processes class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#-9-restore-the-running-processes aria-label=Anchor>#</a></span></h3><p>Create the script:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nano restore-apps.sh</span></span></code></pre></div></div><p>paste:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nv>FILE</span><span class=o>=</span><span class=s2>&#34;/var/tmp/kexec-session/running_apps.txt&#34;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> -f <span class=nv>$FILE</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=nb>read</span> -r app<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nb>command</span> -v <span class=s2>&#34;</span><span class=nv>$app</span><span class=s2>&#34;</span> <span class=p>&amp;</span>&gt;/dev/null<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>nohup <span class=s2>&#34;</span><span class=nv>$app</span><span class=s2>&#34;</span> <span class=p>&amp;</span>&gt;/dev/null <span class=p>&amp;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Started </span><span class=nv>$app</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span> &lt; <span class=s2>&#34;</span><span class=nv>$FILE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;No app list found!&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span></span></span></code></pre></div></div><p>Make executable:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chmod +x restore-apps.sh</span></span></code></pre></div></div><p>Run:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./restore-apps.sh</span></span></code></pre></div></div><p>üîÅ This script re-launches every saved app like <code>firefox</code>, <code>code</code>, <code>chromium</code>, etc., if available.</p><p><strong>A. Check System Boot Time:</strong></p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>who -b</span></span></code></pre></div></div><h2 class="relative group"><strong>Kernel Patching Demo on Arch Linux: A Step-by-Step Guide</strong><div id=kernel-patching-demo-on-arch-linux-a-step-by-step-guide class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#kernel-patching-demo-on-arch-linux-a-step-by-step-guide aria-label=Anchor>#</a></span></h2><p>This guide walks you through the process of setting up a basic kernel patching demo on Arch Linux using the <code>kpatch</code> tool. We will be writing a simple kernel module and loading it into the kernel using <code>insmod</code>.</p><h3 class="relative group"><strong>1. Install Required Dependencies</strong><div id=1-install-required-dependencies class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#1-install-required-dependencies aria-label=Anchor>#</a></span></h3><p>First, we need to install the necessary packages to work with kernel modules:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo pacman -S linux-headers git base-devel</span></span></code></pre></div></div><p><strong>Explanation:</strong></p><ul><li><p><code>linux-headers</code>: Provides kernel headers that are required to compile kernel modules.</p></li><li><p><code>git</code>: Used to clone repositories from GitHub.</p></li><li><p><code>base-devel</code>: Installs essential development tools like <code>gcc</code>, <code>make</code>, and others required for compiling and building kernel modules.</p></li></ul><p>After that, install additional dependencies:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo pacman -S linux-headers gcc make elfutils</span></span></code></pre></div></div><p><strong>Explanation:</strong></p><ul><li><p><code>gcc</code>: The GNU Compiler Collection, needed to compile C code.</p></li><li><p><code>make</code>: A build automation tool used to compile and link files.</p></li><li><p><code>elfutils</code>: Tools to work with ELF (Executable and Linkable Format) binaries, which is the format used by Linux kernel modules.</p></li></ul><h3 class="relative group"><strong>2. Clone the</strong> <code>kpatch</code> Repository<div id=2-clone-the-kpatch-repository class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#2-clone-the-kpatch-repository aria-label=Anchor>#</a></span></h3><p>Next, clone the <code>kpatch</code> GitHub repository. This will allow us to access the kernel patching demo files:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/dynup/kpatch.git</span></span></code></pre></div></div><p><strong>Explanation:</strong></p><ul><li>This command clones the repository containing the necessary files to create a kernel patch.</li></ul><h3 class="relative group"><strong>3. Create a Kernel Patch Demo Directory</strong><div id=3-create-a-kernel-patch-demo-directory class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#3-create-a-kernel-patch-demo-directory aria-label=Anchor>#</a></span></h3><p>Create a new directory where we will place the kernel module code:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mkdir ~/kpatch-demo
</span></span><span class=line><span class=cl><span class=nb>cd</span> ~/kpatch-demo</span></span></code></pre></div></div><p><strong>Explanation:</strong></p><ul><li><p><code>mkdir ~/kpatch-demo</code>: Creates a new directory to work in.</p></li><li><p><code>cd ~/kpatch-demo</code>: Navigates into the newly created directory.</p></li></ul><h3 class="relative group"><strong>4. Write the Kernel Module Code (hello.c)</strong><div id=4-write-the-kernel-module-code-helloc class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#4-write-the-kernel-module-code-helloc aria-label=Anchor>#</a></span></h3><p>Now, create a file named <code>hello.c</code> with the following content:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1>#include &lt;linux/module.h&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>#include &lt;linux/kernel.h&gt;</span>
</span></span><span class=line><span class=cl><span class=c1>#include &lt;linux/init.h&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>MODULE_LICENSE<span class=o>(</span><span class=s2>&#34;GPL&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>MODULE_AUTHOR<span class=o>(</span><span class=s2>&#34;Your Name&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>MODULE_DESCRIPTION<span class=o>(</span><span class=s2>&#34;A Simple Hello World Kernel Module&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>static int __init hello_init<span class=o>(</span>void<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    printk<span class=o>(</span>KERN_INFO <span class=s2>&#34;Hello, BCS_4A! Project Present to Sir Amin\n&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> 0<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>static void __exit hello_exit<span class=o>(</span>void<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    printk<span class=o>(</span>KERN_INFO <span class=s2>&#34;Goodbye, BCS_4A!\n&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>module_init<span class=o>(</span>hello_init<span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>module_exit<span class=o>(</span>hello_exit<span class=o>)</span><span class=p>;</span></span></span></code></pre></div></div><p><strong>Explanation:</strong></p><ul><li><p><code>hello.c</code> is a basic Linux kernel module that prints messages to the kernel log.</p></li><li><p><code>hello_init</code>: This function is executed when the module is loaded into the kernel. It prints &ldquo;Hello, BCS_4A! Project Present to Sir Amin&rdquo; to the kernel log.</p></li><li><p><code>hello_exit</code>: This function is executed when the module is unloaded. It prints &ldquo;Goodbye, BCS_4A!&rdquo;.</p></li><li><p><code>module_init</code> and <code>module_exit</code>: These macros define the functions that should run when the module is loaded or unloaded, respectively.</p></li></ul><h3 class="relative group"><strong>5. Create the Makefile</strong><div id=5-create-the-makefile class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#5-create-the-makefile aria-label=Anchor>#</a></span></h3><p>Create a <code>Makefile</code> to build the kernel module:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>obj-m +<span class=o>=</span> hello.o
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>all:
</span></span><span class=line><span class=cl>	make -C /lib/modules/<span class=k>$(</span>shell uname -r<span class=k>)</span>/build <span class=nv>M</span><span class=o>=</span><span class=k>$(</span>PWD<span class=k>)</span> modules
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>clean:
</span></span><span class=line><span class=cl>	make -C /lib/modules/<span class=k>$(</span>shell uname -r<span class=k>)</span>/build <span class=nv>M</span><span class=o>=</span><span class=k>$(</span>PWD<span class=k>)</span> clean</span></span></code></pre></div></div><p><strong>Explanation:</strong></p><ul><li><p><code>obj-m += hello.o</code>: This line tells the build system to create a kernel module from the <code>hello.c</code> file.</p></li><li><p><code>make -C /lib/modules/$(shell uname -r)/build M=$(PWD) modules</code>: This command uses <code>make</code> to build the kernel module using the kernel headers from your current running kernel.</p></li><li><p><code>clean</code>: This target is used to clean up the generated files (e.g., <code>.o</code> and <code>.ko</code> files) after you&rsquo;re done.</p></li></ul><h3 class="relative group"><strong>6. Build the Kernel Module</strong><div id=6-build-the-kernel-module class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#6-build-the-kernel-module aria-label=Anchor>#</a></span></h3><p>Once the <code>hello.c</code> and <code>Makefile</code> are created, run the following command to compile the module:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>make</span></span></code></pre></div></div><p><strong>Explanation:</strong></p><ul><li><p>This compiles the kernel module. It will generate the <code>hello.ko</code> file, which is the compiled kernel object.</p><h3 class="relative group"><strong>7. Insert the Kernel Module</strong><div id=7-insert-the-kernel-module class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#7-insert-the-kernel-module aria-label=Anchor>#</a></span></h3><p>Next, insert the module into the kernel using <code>insmod</code>:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo insmod hello.ko</span></span></code></pre></div></div><p><strong>Explanation:</strong></p><ul><li><code>insmod hello.ko</code>: This command inserts the <code>hello.ko</code> module into the kernel.</li></ul></li></ul><h3 class="relative group"><strong>8. Verify the Module is Loaded</strong><div id=8-verify-the-module-is-loaded class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#8-verify-the-module-is-loaded aria-label=Anchor>#</a></span></h3><p>Check if the module is loaded using <code>lsmod</code>:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lsmod <span class=p>|</span> grep hello</span></span></code></pre></div></div><p><strong>Explanation:</strong></p><ul><li><code>lsmod | grep hello</code>: This checks if the <code>hello</code> module is loaded into the kernel.</li></ul><h3 class="relative group"><strong>9. View Kernel Log Messages</strong><div id=9-view-kernel-log-messages class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#9-view-kernel-log-messages aria-label=Anchor>#</a></span></h3><p>Use the <code>dmesg</code> command to see the messages printed by your kernel module:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dmesg <span class=p>|</span> tail</span></span></code></pre></div></div><p><strong>Explanation:</strong></p><ul><li><code>dmesg | tail</code>: Displays the last few kernel log messages, which should include the &ldquo;Hello, BCS_4A! Project Present to Sir Amin&rdquo; message from your kernel module.</li></ul><h3 class="relative group"><strong>10. Resolve Issues (if any)</strong><div id=10-resolve-issues-if-any class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#10-resolve-issues-if-any aria-label=Anchor>#</a></span></h3><p>If you face issues like permission errors, you may need to add your user to the <code>adm</code> group to access the kernel logs:</p><div class=highlight-wrapper><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo usermod -aG adm <span class=nv>$USER</span></span></span></code></pre></div></div><p><strong>Explanation:</strong></p><ul><li><code>usermod -aG adm $USER</code>: Adds your user to the <code>adm</code> group, which is required to view kernel logs.</li></ul><p>After running this command, log out and log back in for the changes to take effect.</p><p>üéâ <strong>Boom! You just did a kernel-level patching module.</strong></p><h2 class="relative group"><strong>LSKLM Domain Explanation Table:</strong><div id=lsklm-domain-explanation-table class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#lsklm-domain-explanation-table aria-label=Anchor>#</a></span></h2><p>| <strong>Task</strong> | <strong>LSKLM Domain</strong> | <strong>Explanation</strong> |
|
|
|
|</p><table><tbody><tr><td colspan=1 rowspan=1><p>Used kexec to switch kernels without full reboot</p></td><td colspan=1 rowspan=1><p>Runtime Management</p></td><td colspan=1 rowspan=1><p><code>kexec</code> directly interacts with the kernel to bypass bootloader and jump into a new kernel</p></td></tr></tbody></table><table><tbody><tr><td colspan=1 rowspan=1><p>Tracked and restored user sessions after kexec</p></td><td colspan=1 rowspan=1><p>Process and Session Management</p></td><td colspan=1 rowspan=1><p>You‚Äôre handling the userland layer like session managers do after a reboot</p></td></tr></tbody></table><table><tbody><tr><td colspan=1 rowspan=1><p>Mounted, cleaned filesystems before kexec -e</p></td><td colspan=1 rowspan=1><p>Filesystem and Runtime Safety</p></td><td colspan=1 rowspan=1><p>Ensures clean mounts to avoid kernel panic or data loss</p></td></tr></tbody></table><table><tbody><tr><td colspan=1 rowspan=1><p>Tested multiple kernel versions</p></td><td colspan=1 rowspan=1><p>Kernel Upgrade Management</p></td><td colspan=1 rowspan=1><p>Switching between kernels touches admin-level LSKLM topics</p></td></tr></tbody></table><table><tbody><tr><td colspan=1 rowspan=1><p>Used systemd for session restoration automation</p></td><td colspan=1 rowspan=1><p>Init Systems and Kernel-Service Coordination</p></td><td colspan=1 rowspan=1><p>Hooks into system boot ‚Äî within LSKLM scope</p></td></tr></tbody></table><h3 class="relative group">Conclusion<div id=conclusion class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 -start-6 not-prose group-hover:opacity-100 select-none"><a class="text-primary-300 dark:text-neutral-700 !no-underline" href=#conclusion aria-label=Anchor>#</a></span></h3><ul><li><p>Kexec helps reduce boot time by skipping firmware and bootloader.</p></li><li><p>Useful during kernel updates to minimize downtime.</p></li><li><p>Preserving services ensures smooth recovery.</p></li><li><p>Tools like <code>systemd-analyze</code> help measure improvements.</p></li><li><p>Ideal for production systems and fast recovery setups.</p></li></ul><p>If you liked this guide, feel free to reach out or drop comments for queries. Keep experimenting, and happy containerizing! üê≥‚öôÔ∏è</p><p><strong>P.S.</strong><br>If you spot any mistakes, please don&rsquo;t hesitate to point them out. We&rsquo;re all here to learn together! üòä
<strong>Haris</strong><br>FAST (NUCES)<br>BS Computer Science | Class of 2027</p><p>üìå <strong>Portfolio</strong>: <a href=https://zenvila.github.io/ target=_blank>zenvila.github.io</a><br>üìå <strong>GitHub</strong>: <a href=https://github.com/Zenvila target=_blank>github.com/Zenvila</a><br>üìå <strong>LinkedIn</strong>: <a href=https://www.linkedin.com/in/haris-shahzad-7b8746291/ target=_blank>linkedin.com/in/haris-shahzad-7b8746291</a><br>üìå <strong>Member</strong>: COLAB (Research Lab)</p></div></div><script type=text/javascript src=/js/page.min.54b6f4371722649edbe871e431d8670d670878c22be8f36e229fe53cc9b786fe25a834def5e6de621f7a3e37b72bc8cd73839aa5ed907ed6cbd45cd3e1b0fa20.js integrity="sha512-VLb0NxciZJ7b6HHkMdhnDWcIeMIr6PNuIp/lPMm3hv4lqDTe9ebeYh96Pje3K8jNc4Oape2QftbL1FzT4bD6IA==" data-oid=views_posts/preserving-services-with-faster-kernel-reboots-using-kexec.md data-oid-likes=likes_posts/preserving-services-with-faster-kernel-reboots-using-kexec.md></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span class="flex flex-col"><a class="flex text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/kubernetes-using-minikube-on-arch-linux/><span class=leading-6><span class="inline-block rtl:rotate-180">&larr;</span>&ensp;Kubernetes Using Minikube On Arch Linux
</span></a><span class="ms-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2024-07-28T00:00:00+00:00>28 July 2024</time>
</span></span><span class="flex flex-col items-end"><a class="flex text-right text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" href=/posts/mysteries-of-computer-architecture/><span class=leading-6>Mysteries Of Computer Architecture&ensp;<span class="inline-block rtl:rotate-180">&rarr;</span>
</span></a><span class="me-6 mt-1 text-xs text-neutral-500 dark:text-neutral-400"><time datetime=2024-09-19T00:00:00+00:00>19 September 2024</time></span></span></div></div></footer></article><div id=scroll-to-top class="fixed bottom-6 end-6 z-50 transform translate-y-4 opacity-0 duration-200"><a href=#the-top class="pointer-events-auto flex h-12 w-12 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2026
Haris Shahzad</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh] z-500" data-url=https://zenvila.github.io/><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>