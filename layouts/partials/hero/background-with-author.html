{{ $disableImageOptimization := site.Store.Get "disableImageOptimization" }}

{{ $useDefault := false }}
{{ $featured := "" }}
{{ $featuredURL := "" }}
{{ with .Params.featureimage }}
  {{ if or (strings.HasPrefix . "http:") (strings.HasPrefix . "https:") }}
    {{ if site.Params.hotlinkFeatureImage }}
      {{ $featuredURL = . }}
    {{ else }}
      {{ $featured = resources.GetRemote . }}
    {{ end }}
  {{ else }}
    {{ $featured = resources.Get . }}
  {{ end }}
{{ end }}

{{ if not (or $featured $featuredURL) }}
  {{ $images := .Resources.ByType "image" }}
  {{ range slice "*background*" "*feature*" "*cover*" "*thumbnail*" }}
    {{ if not $featured }}{{ $featured = $images.GetMatch . }}{{ end }}
  {{ end }}
{{ end }}

{{ if not (or $featured $featuredURL) }}
  {{ $default := site.Store.Get "defaultBackgroundImage" }}
  {{ if $default.url }}
    {{ $featuredURL = $default.url }}
    {{ $useDefault = true }}
  {{ else if $default.obj }}
    {{ $featured = $default.obj }}
    {{ $useDefault = true }}
  {{ end }}
{{ end }}

{{/* generate image URL if not hotlink */}}
{{ if not $featuredURL }}
  {{ with $featured }}
    {{ $featuredURL = .RelPermalink }}
    {{ if not (or $disableImageOptimization (eq .MediaType.SubType "svg")) }}
      {{ $size := site.Store.Get "backgroundImageWidth" }}
      {{ $featuredURL = (.Resize $size).RelPermalink }}
    {{ end }}
  {{ end }}
{{ end }}

{{ $isParentList := eq (.Scratch.Get "scope") "list" }}
{{ $shouldBlur := $.Params.layoutBackgroundBlur | default (or
  (and ($.Site.Params.article.layoutBackgroundBlur | default true) (not $isParentList))
  (and ($.Site.Params.list.layoutBackgroundBlur | default true) ($isParentList))
  )
}}
{{ $shouldAddHeaderSpace := $.Params.layoutBackgroundHeaderSpace | default (or
  (and ($.Site.Params.article.layoutBackgroundHeaderSpace | default true) (not $isParentList))
  (and ($.Site.Params.list.layoutBackgroundHeaderSpace | default true) ($isParentList))
  )
}}

{{- with $featuredURL -}}
  {{ if $shouldAddHeaderSpace | default true }}
    <div id="hero" class="h-[150px] md:h-[200px]"></div>
  {{ end }}
  <div class="fixed inset-x-0 top-0 h-[600px] single_hero_background nozoom">
    {{ $style := "" }}
    {{ $defaultPosition := cond $useDefault site.Params.imagePosition false }}
    {{ with $.Params.imagePosition | default $defaultPosition }}
      {{ $style = printf "object-position: %s;" . }}
    {{ end }}
    <img
      id="background-image"
      src="{{ . }}"
      role="presentation"
      loading="eager"
      decoding="async"
      fetchpriority="high"
      class="absolute inset-0 w-full h-full object-cover"
      {{ if $style }}style="{{ $style | safeCSS }}"{{ end }}>
    <div
      class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div>
    <div
      class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div>
  </div>

  {{/* Author Info Section - Scrolls with page content */}}
  <div class="relative z-10 -mt-[500px] pt-32 px-6 md:px-12 pb-8">
      {{/* Page Title - Upper Left (only show if not Projects) */}}
      {{ if ne $.Title "Projects" }}
        <div class="mb-8">
          <h1 class="text-5xl md:text-6xl font-extrabold text-white mb-2">{{ $.Title }}</h1>
          <div class="flex items-center gap-2">
            <div class="h-px w-12 bg-neutral-400"></div>
            <svg class="w-5 h-5 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
          </div>
        </div>
      {{ end }}

      {{/* Author Section - Left side with profile pic, right side with info */}}
      {{ if $.Params.showAuthor | default true }}
        <div class="flex flex-col md:flex-row items-start gap-6 md:gap-8 md:ml-4">
          {{/* Profile Picture - Left */}}
          {{ with $.Site.Params.Author.image }}
            {{ $authorImage := "" }}
            {{ if or (strings.HasPrefix . "http:") (strings.HasPrefix . "https:") }}
              {{ if site.Params.hotlinkFeatureImage }}
                {{ $authorImage = . }}
              {{ else }}
                {{ $authorImage = resources.GetRemote . }}
              {{ end }}
            {{ else }}
              {{ $authorImage = resources.Get . }}
            {{ end }}
            {{ if $authorImage }}
              <div class="flex-shrink-0 md:mr-6">
                {{ $isURL := or (strings.HasPrefix . "http:") (strings.HasPrefix . "https:") }}
                {{ $isHotlink := and $isURL site.Params.hotlinkFeatureImage }}
                {{ if $isHotlink }}
                  <img
                    class="h-32 w-32 md:h-40 md:w-40 rounded-full border-4 border-cyan-400/30 shadow-lg"
                    src="{{ $authorImage }}"
                    alt="{{ $.Site.Params.Author.name | default `Author` }}"
                    width="160"
                    height="160">
                {{ else if $isURL }}
                  {{ $final := $authorImage }}
                  {{ if not (or $disableImageOptimization (eq $authorImage.MediaType.SubType "svg")) }}
                    {{ $final = $authorImage.Fill "320x320 q96" }}
                  {{ end }}
                  <img
                    class="h-32 w-32 md:h-40 md:w-40 rounded-full border-4 border-cyan-400/30 shadow-lg"
                    src="{{ $final.RelPermalink }}"
                    alt="{{ $.Site.Params.Author.name | default `Author` }}"
                    width="160"
                    height="160">
                {{ else }}
                  {{ $final := $authorImage }}
                  {{ if not (or $disableImageOptimization (eq $authorImage.MediaType.SubType "svg")) }}
                    {{ $final = $authorImage.Fill "320x320 q96" }}
                  {{ end }}
                  <img
                    class="h-32 w-32 md:h-40 md:w-40 rounded-full border-4 border-cyan-400/30 shadow-lg"
                    src="{{ $final.RelPermalink }}"
                    alt="{{ $.Site.Params.Author.name | default `Author` }}"
                    width="160"
                    height="160">
                {{ end }}
              </div>
            {{ end }}
          {{ end }}

          {{/* Author Info - Right with gap from image */}}
          <div class="flex flex-col md:ml-2">
            <div class="text-sm uppercase tracking-wider text-neutral-300 mb-1">Author</div>
            <h2 class="text-3xl md:text-4xl font-bold text-white mb-2">
              {{ $.Site.Params.Author.name | default $.Site.Title }}
            </h2>
            {{ with $.Site.Params.Author.headline }}
              <div class="text-lg md:text-xl text-neutral-300 mb-4">
                {{ . | markdownify }}
              </div>
            {{ end }}
            
            {{/* Social Links */}}
            {{ with $.Site.Params.Author.links }}
              <div class="flex flex-wrap gap-4 text-2xl">
                {{ range $links := . }}
                  {{ range $name, $url := $links }}
                    <a
                      class="text-neutral-300 hover:text-white transition-colors"
                      href="{{ $url | safeURL }}"
                      target="_blank"
                      aria-label="{{ $name | title }}"
                      title="{{ $name | title }}"
                      rel="me noopener noreferrer">
                      <span class="inline-block align-text-bottom">{{ partial "icon.html" $name }}</span>
                    </a>
                  {{ end }}
                {{ end }}
              </div>
            {{ end }}
          </div>
        </div>
      {{ end }}
  </div>

  {{ if $shouldBlur | default false }}
    <div
      id="background-blur"
      class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-xl bg-neutral-100/75 dark:bg-neutral-800/60"></div>
    {{ $backgroundBlur := resources.Get "js/background-blur.js" }}
    {{ $backgroundBlur = $backgroundBlur | resources.Minify | resources.Fingerprint ($.Site.Params.fingerprintAlgorithm | default "sha512") }}
    <script
      type="text/javascript"
      src="{{ $backgroundBlur.RelPermalink }}"
      integrity="{{ $backgroundBlur.Data.Integrity }}"
      data-blur-id="background-blur"
      data-image-id="background-image"
      data-image-url="{{ . }}"></script>
  {{ end }}
{{- end -}}

